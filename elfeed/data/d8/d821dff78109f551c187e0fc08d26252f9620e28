<p>I've been running my backups by hand<sup class="footnote-reference"><a href="#by-hand">1</a></sup> every week on my laptop for as long as they've been set up.
Automating them was something important but was on the back burner, because, well, it never felt very important.
Then I lost a few days of work when <a href="/blog/setting-up-a-new-machine-2023/">my SSD died</a>, and it felt more urgent.</p>
<p>Haha, no, I still kept doing it manually every week.</p>
<p>It was really a friend talking to me and reminding me that I should do it that kicked me into gear.
And there was an episode of <a href="https://changelog.com/podcast">Changelog</a> which talked about <a href="https://ntfy.sh/">ntfy</a>.
Things kind of came together and I decided to finally automate the backups.
Then I procrastinated for two months, and did it in January of 2024!</p>
<h1 id="what-do-i-want">What do I want?</h1>
<p>For automated backups, we have a few requirements.</p>
<p>First, clearly, we need backups to run automatically.
These should run <em>daily</em>.
And I also want a snapshot pruning job to run <em>weekly</em> to keep my storage costs down.</p>
<p>Then we also need alerting.
I want to know if a backup has not been generated for three days.
(One or two day gaps are expected, since I'll often have my laptop off for travel.)
I want this to send a notification to my phone in some form: alert, email, text, I don't care.
Locally notifying my on my laptop would also be nice, in case the laptop is on but backups broke.</p>
<p>And finally we need to have periodic tests of the backups.
Backups aren't worth a lot if they don't work, so you should sometimes check that they do!
And I definitely did this one, but no spoilers.
Definitely did it.</p>
<h1 id="running-tasks-daily">Running tasks daily</h1>
<p>Running things on a schedule is the bread and butter of <a href="https://en.wikipedia.org/wiki/Cron">cron</a>.
The only snag is that I do not expect my laptop to always be powered on, so the job may sometimes be scheduled to run when it's sleeping or off.
The answer to this came from <a href="https://docs.fedoraproject.org/en-US/fedora/latest/system-administrators-guide/monitoring-and-automation/Automating_System_Tasks/">Fedora's docs</a>: we should use <a href="https://en.wikipedia.org/wiki/Anacron">anacron</a>.</p>
<p>anacron lets you run jobs just like cron, but handles downtime.
If the computer is off (or on battery power), jobs are not run.
Then when the computer is back on AC power, it will run the jobs!
For backups, this is great.</p>
<p>To set it up, I created two files.
For the daily backups, I put this script in <code> /etc/cron.daily/0backups</code>:</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">#!&#x2F;bin&#x2F;bash
set -o errexit -o nounset -o xtrace

cronic &#x2F;home&#x2F;nicole&#x2F;Code&#x2F;management-scripts&#x2F;nightly_backup.sh
</code></pre>
<p>And for the weekly pruning, this is in <code>/etc/cron.weekly/0prune</code>:</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">#!&#x2F;bin&#x2F;bash
set -o errexit -o nounset -o xtrace

cronic &#x2F;home&#x2F;nicole&#x2F;Code&#x2F;management-scripts&#x2F;weekly_prune.sh
</code></pre>
<p>There's one other thing in there, <code>cronic</code>.
When tasks fail with anacron, they send mail to you!
Not like email, though that can be supported I think?
But local system mail, which the <code>mail</code> command will show you.</p>
<p>With anacron, it will send mail for <em>any</em> output, which is pretty annoying for automated daily tasks.
I just want to know if it fails!
What <a href="http://habilis.net/cronic/">cronic</a> does is collect all the input and only emit it if there is a failure (a non-zero return code), so you only get mail for the failures.</p>
<p>To send and receive that mail locally, I installed postfix and configured it for local-only delivery, which is the default on Fedora.
On my Debian machine, I had to install the <code>mailutils</code> package also to have the <code>mail</code> command.
Having this mail was <em>critical</em> for debugging my jobs, because otherwise I could not see what was happening when it ran!</p>
<h1 id="alerting-if-it-breaks">Alerting if it breaks</h1>
<p>Okay, so now we have our backups running daily.
Or so we hope.
How will I know if it breaks?</p>
<p>The answer is, like the answer to so many things, to throw more software at it!
Here we have two pieces involved.</p>
<p>First we have <a href="https://ntfy.sh/">ntfy</a>, which lets you send push notifications when something happens.
(I know we want to know when something <em>doesn't</em> happen, sssshhhhh, we'll get there).
I have it send me a notification whenever the jobs run.
You can configure its priority, so a successful backup is a quiet notification, but a failure gives me an actual notification that buzzes my phone.</p>
<p>This is an example of how I have it setup in my backup script, with keys omitted.
Basically, if the <code>backup.sh</code> script succeeds, it will ping ntfy (and another service, sssshhhhhh), but if it fails, it'll ping ntfy even <em>harder</em>.</p>
<pre data-lang="bash" class="language-bash "><code class="language-bash" data-lang="bash">bash backup.sh \
    &amp;&amp; curl -H prio:low -H &quot;Title: Backup success&quot; -d &quot;$DEVICE backup succeeded!&quot; -s $NTFY_URL \
    &amp;&amp; curl -fsS -m 10 --retry 5 -o &#x2F;dev&#x2F;null $HC_URL \
    || curl -H prio:high -H &quot;Tags: rotating_light&quot; -H &quot;Title: Backup failure&quot; -d &quot;$DEVICE backup failed!&quot; -s $NTFY_URL
</code></pre>
<p>So that's the happy path, and it does give me a lot of peace of mind to see a notification every morning that my servers backed up successfully.</p>
<p>To get the alerts if the backups never run, we turn to <a href="https://healthchecks.io/">Healthchecks.io</a>.
It does integrate with ntfy, but I'm not sure that it goes the direction I want and can <em>receive</em> from ntfy.
Anyway, I didn't figure that piece out.
What I did do is integrate it in the same way, with a curl if the job passes and nothing if it fails.</p>
<p>For each machine I back up, I have them set up to expect a ping every day.
If Healthchecks.io receives the ping on time, then we're all good.
If not, it waits for the grace period (6 hours for my servers, 3 days for my laptop to accommodate travel<sup class="footnote-reference"><a href="#travel">2</a></sup>), and then it alerts me by email.</p>
<h1 id="testing-the-backups">Testing the backups</h1>
<p>So that just leaves us with testing that our backups work.
I, uh.
I'll get back to you on automating this bit.</p>
<p>For now, I have a periodic test where I will restore files.
It's manual, and it works, and it gives me peace of mind to see the backups restoring successfully.</p>
<p>If anyone has better ideas for automation of backups, or if you have a way you like to test backups, I'd love to hear about it!</p>
<hr />
<div class="footnote-definition" id="by-hand"><sup class="footnote-definition-label">1</sup>
<p>Here, &quot;by hand&quot; means running the script that does it, but having to run that script myself.</p>
</div>
<div class="footnote-definition" id="travel"><sup class="footnote-definition-label">2</sup>
<p>I was away for four days last week, and it did indeed alert me!</p>
</div>
